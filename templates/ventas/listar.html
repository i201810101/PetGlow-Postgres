{% extends "base.html" %} {% block title %}Ventas - PetGlow{% endblock %} {%
block extra_css %}
<link
  rel="stylesheet"
  href="{{ url_for('static', filename='css/facturas.css') }}"
/>
<style>
  .ventas-table th {
    background-color: #f8f9fa;
    font-weight: 600;
  }

  .ventas-table tbody tr:hover {
    background-color: #f8f9fa;
  }

  .badge-venta {
    font-size: 0.85em;
    padding: 5px 10px;
  }
</style>
{% endblock %} {% block content %}
<div
  class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom"
>
  <h1 class="h2">Ventas / Facturas</h1>
  <div class="btn-toolbar mb-2 mb-md-0">
    <a
      href="{{ url_for('reservas') }}"
      class="btn btn-sm btn-outline-primary me-2"
    >
      <i class="fas fa-calendar-alt me-1"></i>Ver Reservas
    </a>
  </div>
</div>

<!-- Filtros -->
<div class="card mb-4">
  <div class="card-body">
    <div class="row g-3">
      <div class="col-md-4">
        <div class="input-group">
          <span class="input-group-text"><i class="fas fa-search"></i></span>
          <input
            type="text"
            class="form-control"
            id="buscador-ventas"
            placeholder="Buscar por número, cliente..."
          />
        </div>
      </div>
      <div class="col-md-4">
        <select class="form-select" id="filtro-estado">
          <option value="" selected>Todos los estados</option>
          <option value="pendiente">Pendiente</option>
          <option value="pagada">Pagada</option>
          <option value="anulada">Anulada</option>
          <option value="credito">Crédito</option>
        </select>
      </div>
      <div class="col-md-4">
        <input
          type="date"
          class="form-control"
          id="filtro-fecha"
          placeholder="Filtrar por fecha..."
        />
      </div>
    </div>
  </div>
</div>

<!-- Tabla de ventas -->
<div class="card shadow">
  <div
    class="card-header bg-light d-flex justify-content-between align-items-center"
  >
    <h5 class="mb-0">
      <i class="fas fa-file-invoice-dollar me-2"></i>Lista de Facturas
    </h5>
    <span class="badge bg-dark">{{ ventas|length }}</span>
  </div>

  <div class="card-body p-0">
    <div class="table-responsive">
      <table class="table table-hover mb-0 ventas-table">
        <thead>
          <tr>
            <th>Número</th>
            <th>Fecha</th>
            <th>Cliente</th>
            <th>Reserva</th>
            <th>Total</th>
            <th>Estado</th>
            <th class="text-center">Acciones</th>
          </tr>
        </thead>
        <tbody>
          {% if ventas %} {% for venta in ventas %}
          <tr>
            <td>
              <span class="badge bg-dark">{{ venta.numero }}</span>
              <small class="d-block mt-1">
                <i
                  class="fas {{ venta.tipo_icono }} {{ venta.tipo_color }} me-1"
                ></i>
                {{ venta.tipo_comprobante|title }}
              </small>
            </td>
            <td>
              {% if venta.fecha_emision %} {{
              venta.fecha_emision.strftime('%d/%m/%Y') }}
              <small class="text-muted d-block"
                >{{ venta.fecha_emision.strftime('%H:%M') }}</small
              >
              {% else %}
              <span class="text-muted">-</span>
              {% endif %}
            </td>
            <td>
              {% if venta.cliente_nombre %} {{ venta.cliente_nombre }} {{
              venta.cliente_apellido }} {% else %}
              <span class="text-muted">Cliente no registrado</span>
              {% endif %}
            </td>
            <td>
              {% if venta.codigo_reserva %}
              <span class="badge bg-info">{{ venta.codigo_reserva }}</span>
              {% else %}
              <span class="text-muted">-</span>
              {% endif %}
            </td>
            <td>
              <strong class="d-block"
                >S/ {{ "%.2f"|format(venta.total) }}</strong
              >
              <small class="text-muted">{{ venta.metodo_pago|title }}</small>
            </td>
            <td>
              <span class="badge {{ venta.estado_clase }} badge-venta">
                {{ venta.estado_texto }}
              </span>
            </td>
            <td class="text-center">
              <div class="btn-group btn-group-sm">
                <a
                  href="{{ url_for('ver_factura', id=venta.id_factura) }}"
                  class="btn btn-info"
                  title="Ver detalles"
                >
                  <i class="fas fa-eye"></i>
                </a>
                {% if venta.estado != 'anulada' %}
                <a
                  href="#"
                  class="btn btn-warning"
                  title="Imprimir"
                  onclick="window.open('{{ url_for('ver_factura', id=venta.id_factura) }}?print=true', '_blank')"
                >
                  <i class="fas fa-print"></i>
                </a>
                {% endif %}
              </div>
            </td>
          </tr>
          {% endfor %} {% else %}
          <tr>
            <td colspan="7" class="text-center py-5">
              <div class="py-4">
                <i class="fas fa-file-invoice-dollar fa-3x text-muted mb-3"></i>
                <h5 class="text-muted mb-3">No hay facturas registradas</h5>
                <p class="text-muted mb-4">
                  Las facturas se generan automáticamente desde las reservas
                  completadas
                </p>
                <a href="{{ url_for('reservas') }}" class="btn btn-primary">
                  <i class="fas fa-calendar-alt me-2"></i>Ver Reservas
                </a>
              </div>
            </td>
          </tr>
          {% endif %}
        </tbody>
      </table>
    </div>
  </div>

  <div class="card-footer bg-light">
    <div class="row align-items-center">
      <div class="col-md-6">
        <small class="text-muted">
          Mostrando {{ ventas|length }} facturas
        </small>
      </div>
      <div class="col-md-6 text-end">
        <small class="text-muted">
          Total general:
          <strong>S/ {{ "%.2f"|format(ventas|sum(attribute='total')) }}</strong>
        </small>
      </div>
    </div>
  </div>
</div>
{% endblock %} {% block extra_js %}
<script>
document.addEventListener("DOMContentLoaded", function () {
    // Filtrado de tabla
    const buscador = document.getElementById("buscador-ventas");
    const filtroEstado = document.getElementById("filtro-estado");
    const filtroFecha = document.getElementById("filtro-fecha");
    const filas = document.querySelectorAll(".ventas-table tbody tr");

    function filtrarVentas() {
        const texto = buscador.value.toLowerCase();
        const estado = filtroEstado.value;
        const fecha = filtroFecha.value;

        let filasVisibles = 0;

        filas.forEach((fila) => {
            if (fila.classList.contains("no-data")) return;

            const textoFila = fila.textContent.toLowerCase();
            const estadoFila = fila.querySelector(".badge").textContent.toLowerCase();
            const fechaCelda = fila.cells[1];
            
            // Obtener texto de la celda de fecha
            let fechaFilaTexto = '';
            if (fechaCelda) {
                const spans = fechaCelda.querySelectorAll('strong, small');
                spans.forEach(span => {
                    fechaFilaTexto += span.textContent + ' ';
                });
                fechaFilaTexto = fechaFilaTexto.trim();
            }

            let coincide = true;

            // Filtrar por texto
            if (texto && !textoFila.includes(texto)) {
                coincide = false;
            }

            // Filtrar por estado
            if (estado && !estadoFila.includes(estado)) {
                coincide = false;
            }

            // Filtrar por fecha (solo si se especificó fecha)
            if (fecha) {
                if (!fechaFilaTexto.includes(fecha.split('-').reverse().join('/'))) {
                    coincide = false;
                }
            }

            if (coincide) {
                fila.style.display = "";
                filasVisibles++;
            } else {
                fila.style.display = "none";
            }
        });

        // Mostrar mensaje si no hay resultados
        const sinResultados = document.querySelector("#sin-resultados");
        if (sinResultados) {
            sinResultados.style.display = filasVisibles === 0 ? "" : "none";
        }
    }

    if (buscador) buscador.addEventListener("input", filtrarVentas);
    if (filtroEstado) filtroEstado.addEventListener("change", filtrarVentas);
    if (filtroFecha) filtroFecha.addEventListener("change", filtrarVentas);

    // NO establecer fecha de hoy automáticamente
    // Dejar que el usuario elija si quiere filtrar por fecha
});
</script>
{% endblock %}
